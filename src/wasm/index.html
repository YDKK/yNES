<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="utf-8">
  <title>yNES for Browser</title>
</head>

<body>
  <script type="module">
    const colors = [
      [84, 84, 84],
      [0, 30, 116],
      [8, 16, 144],
      [48, 0, 136],
      [68, 0, 100],
      [92, 0, 48],
      [84, 4, 0],
      [60, 24, 0],
      [32, 42, 0],
      [8, 58, 0],
      [0, 64, 0],
      [0, 60, 0],
      [0, 50, 60],
      [0, 0, 0],
      [0, 0, 0],
      [0, 0, 0],
      [152, 150, 152],
      [8, 76, 196],
      [48, 50, 236],
      [92, 30, 228],
      [136, 20, 176],
      [160, 20, 100],
      [152, 34, 32],
      [120, 60, 0],
      [84, 90, 0],
      [40, 114, 0],
      [8, 124, 0],
      [0, 118, 40],
      [0, 102, 120],
      [0, 0, 0],
      [0, 0, 0],
      [0, 0, 0],
      [236, 238, 236],
      [76, 154, 236],
      [120, 124, 236],
      [176, 98, 236],
      [228, 84, 236],
      [236, 88, 180],
      [236, 106, 100],
      [212, 136, 32],
      [160, 170, 0],
      [116, 196, 0],
      [76, 208, 32],
      [56, 204, 108],
      [56, 180, 204],
      [60, 60, 60],
      [0, 0, 0],
      [0, 0, 0],
      [236, 238, 236],
      [168, 204, 236],
      [188, 188, 236],
      [212, 178, 236],
      [236, 174, 236],
      [236, 174, 212],
      [236, 180, 176],
      [228, 196, 144],
      [204, 210, 120],
      [180, 222, 120],
      [168, 226, 144],
      [152, 226, 180],
      [160, 214, 228],
      [160, 162, 160],
      [0, 0, 0],
      [0, 0, 0],
    ];
    let nes;
    const canvas = document.querySelector("#canvas");
    const ctx = canvas.getContext('2d');
    const image = ctx.createImageData(256, 240);
    let start_time;
    const target_fps = 60;
    const audio_buffer_length = 3025;
    const audio_sample_rate = 178680;
    let rendered_frames = 0;
    let audio_count = 0;
    let audioCtx;
    let audioProcessorNode;
    let audioProcessorBufferLength = 0;
    const audioBuffer = new ArrayBuffer(audio_buffer_length * 4);
    const audioBufferFloat32 = new Float32Array(audioBuffer);

    for (let i = 0; i < 256 * 240; i++) {
      image.data[i * 4 + 3] = 255;//A
    }

    import init, { nes_new, nes_clock, nes_get_screen, WasmPadInputs } from "./pkg/y_nes_wasm.js";
    init()
      .then(() => {
        document.querySelector("#rom").addEventListener('change', function (e) {
          const file = document.querySelector('#rom').files[0];
          const fileReader = new FileReader();
          fileReader.onload = async function webViewerChangeFileReaderOnload(evt) {
            const buffer = evt.target.result;
            const uint8Array = new Uint8Array(buffer);
            nes = nes_new(uint8Array);
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            await audioCtx.audioWorklet.addModule("audio-processor.js");
            audioProcessorNode = new AudioWorkletNode(audioCtx, "audio-processor");
            audioProcessorNode.port.onmessage = (e) => {
              audioProcessorBufferLength = e.data;
            };
            audioProcessorNode.connect(audioCtx.destination);

            rendered_frames = 0;
            start_time = performance.now();
          };
          fileReader.readAsArrayBuffer(file);
        }, true);
      });

    function render(current_time) {
      if (nes == null) {
        window.requestAnimationFrame(render);
        return;
      }

      let time_diff = (current_time - start_time) / 1000;
      let current_frames = Math.floor(time_diff * target_fps);
      let need_render_frames = current_frames - rendered_frames;
      let overload_frames = Math.max(need_render_frames - 5, 0);

      if (target_fps != 60 || (audioProcessorBufferLength <= audio_buffer_length * 2)) {
        let pcm_filled = 0;
        for (let _ = 0; _ < Math.min(need_render_frames, 5); _++) {
          let end_frame = false;
          while (!end_frame) {
            const result = nes_clock(nes);
            end_frame = result.end_frame;
            let apu_out = result.apu_out;
            if (apu_out != undefined) {
              //とりあえず雑に間引く
              if (audio_count % 10 == 0) {
                if (pcm_filled < audio_buffer_length) {
                  audioBufferFloat32[pcm_filled] = apu_out;
                  pcm_filled++;
                }
              }
              audio_count += 1;
              audio_count %= 10;
            }
            result.free();
          }
        }
        if (pcm_filled > 0) {
          audioProcessorNode.port.postMessage({ pcm_filled, audioBufferFloat32 });
        }
      }
      rendered_frames += need_render_frames;

      const screen = nes_get_screen(nes);
      for (let i = 0; i < 256 * 240; i++) {
        const pixel = colors[screen[i]];
        image.data[i * 4 + 0] = pixel[0];//R
        image.data[i * 4 + 1] = pixel[1];//G
        image.data[i * 4 + 2] = pixel[2];//B
      }
      ctx.putImageData(image, 0, 0);
      document.querySelector("#frame").textContent = rendered_frames;
      if (overload_frames != 0) {
        document.querySelector("#load").textContent = " [overload!]";
      }

      window.requestAnimationFrame(render);
    }

    window.requestAnimationFrame(render);
  </script>
  <h1 style="font-size: 1.5rem;">yNES for Browser</h1>
  <canvas id="canvas" width="256" height="240"></canvas><br>
  <input type="file" id="rom" accept=".nes"><br>
  Frame: <span id="frame"></span><span id="load"></span>
</body>

</html>